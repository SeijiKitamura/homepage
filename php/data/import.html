<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/html4/loose.dtd">

<html lang="ja">
 <head>
  <!-- META系(全ページ共通) -->
  <meta http-equiv="Content-language" content="ja">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Script-Type" content="text/javascript">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta name="ROBOTS" content="noindex,nofollow">
  <meta name="description" content="東京都大田区南馬込にある食品スーパーマーケット、スーパーキタムラの公式サイト。年中無休、営業時間AM9:30-PM10:00。">
  <meta name="keywords" content="キタムラ,スーパーキタムラ,スーパーきたむら,スーパー北村,シェノール,惣菜,パン,お酒,日本酒,焼酎,ワイン,配達">

  <!-- タイトル(ページごとに変更) -->
  <title>データ更新:食品スーパーマーケット　</title>

  <!-- link(ページごとに変更) -->
  <link rel="icon" href="../../img/kitamura.ico" type="type/ico" sizes="16x16" /> 
  <link rel="stylesheet" href="../../css/kitamura.css" /> 
  <link rel="next" href="" /> <!-- 次のページ -->
  <link rel="prev" href=""/>  <!-- 前のページ -->

  <!-- スクリプト(全ページ共通) -->
  <script type="text/javascript" src="../../js/jquery.js"></script>
  <script type="text/javascript" src="../../js/jquery.upload.js"></script>
  <script>
//======================== global変数 ==================//
var h="div#header";
var l="div#leftside";
var r="div#rightside";
var m="div#main";
var f="div#footer";
var bz=m+" div.btnzone";
var dz=m+" div.datazone";
//======================== global変数 ==================//


//======================== $(function) 開始 ==================//
$(function(){

 $("#leftside ul li a").click(function(){
  var cls=$(this).attr("class");
  Init(cls);
 });
});
//======================== $(function) 終了 ==================//

//======================== Init 開始 ==================//
function Init(filename){
 //mainを初期化
 $(bz).empty();
 $(dz).empty();


 //ボタン追加(チラシ画像更新を除く)
 if(filename!="tirasiimage" && filename!="reserveimage"){
  var btn="<input type='file' name='"+filename+"' enctype='multipart/form-data'>";
  $(bz).append(btn);
 }//if

 //SELECTタグ追加(チラシ画像更新のみ)
 if(filename=="tirasiimage"){
  var url="jsonGetTitleList.php";
  var data="";
  $.get(url,data,function(html){
   var msg="";
   if(html.match(/エラー/)){
    $(bz).empty()
         .append(html);
    $(dz).empty();
    return false;
   }//if

   //JSON形式に変換
   var json=eval("("+html+")");
   if(! json){
    $(bz).empty()
         .append("データがありません");
    $(dz).empty();
    return false;
   }//if

   if(! json["status"]){
    $(bz).empty()
         .append("原因不明のエラーです。");
    $(dz).empty();
    return false;
   }

   //OPTIONタグ生成
   var opt="";
   opt+="<option value='999999999'>チラシを選択してください</option>\n";
   for(var i in json["data"]){
    opt+="<option value='"+json["data"][i]["tirasi_id"]+"'>";
    opt+=json["data"][i]["hiduke"]+" "+json["data"][i]["title"];
    opt+="</option>\n";
   }//for

   //SELECTタグ生成
   $(bz).empty();
   $("<select>").append(opt)
                .appendTo($(bz))
                .change(function(){getImageList($(this).val());});
   
  });//$.get
 }//if

 if(filename==="reserveimage"){
  getReserveList();
  return;
 }//if

 if(filename==="janmas"){
  var msg ="1度に更新できるデータはおよそ15000件程度となります。";
      msg+="それ以上の場合はデータを減らして対応してください";

      $(bz).append(msg);
 }

 //イベント追加
 $(bz+" input[name='"+filename+"']").change(function(){
  var n=$(this).attr("name");
  if(n=="calendar")    setCalendarCSV($(this));
  if(n=="tirasititle") setTirasiTitleCSV($(this));
  if(n=="tirasiitem")  setTirasiItemCSV($(this));
  if(n=="janmas")      setJanMasCSV($(this));
  if(n=="clsmas")      setClsMasCSV($(this));
  if(n=="reserve")     setReserveCSV($(this));
 });
 

}
//======================== Init 終了 ==================//

//======================== getImageList 開始============//
function getImageList(tirasi_id){
 $(dz).empty();

 //引数チェック
 if(! tirasi_id.match(/^[0-9]+$/)){
  $(dz).empty
       .append("チラシ番号が不正です");
  return false;
 }

 if(! tirasi_id) return false;
 var url="jsonGetImageList.php";
 var data={"tirasi_id":tirasi_id};
 $.get(url,data,function(html){
  //エラーチェック
  if(html.match(/エラー/)){
   $(dz).empty()
        .append(html);
   return false;
  }//if
  
  //JSONへ変換
  var json=eval("("+html+")");
  if(! json){
   $(dz).empty()
        .append("データがありません");
   return false;
  }

  var li="";

  //データ生成
  //(キャッシュを使用しないよう、無効な文字をファイルにつける）
  var tstamp=new Date().getTime();
  for(var i in json["data"]){
   var j=json["data"][i];
   li+="<li>";
   li+="<div class='col2block'>";
   li+="<img src='../../img/"+j["jcode"]+".jpg?"+tstamp+"'>";
   li+="</div>\n";

   li+="<div class='col3block'>";
   li+="<div class=''>"+j["maker"]+"</div>";
   li+="<div class=''>"+j["sname"]+"</div>";
   li+="<div class=''>JAN:"+j["jcode"]+"</div>";
   li+="<div class=''>"+j["tani"]+" "+j["baika"]+"</div>";
   li+="</div>\n";

   li+="<div class='col3block'>";
   li+="<div class=''>画像URL:<input type='text' name='url_"+j["jcode"]+"'></div>";
   li+="<div class=''>";
   //以下のname属性を変更する場合、jsonSetImageUpLoad.phpの$_FILESも
   //変更してください
   li+="<input type='file' value='アップロード' name='upload_"+j["jcode"]+"' enctype='multipart/form-data'>";
   li+="</div>";
   li+="<div class=''>";
   li+="<input type='button' value='この画像を削除する' name='del_"+j["jcode"]+"'>";
   li+="</div>";
   li+="</div>\n";

   li+="<div class='clr'></div>";

   li+="</li>\n";
  }//for

  //データ表示
  $("<ul>").append(li)
          .appendTo($(dz));
  
  //画像URL イベント追加
  $(dz +" ul li div.col3block div input[name^='url_']").change(function(){
   setImageUrl($(this));
  });

  //ファイル選択 イベント追加
  $(dz +" ul li div.col3block div input[name^='upload_']").change(function(){
   setImageUpLoad($(this));
  });

  //削除 イベント追加
  $(dz +" ul li div.col3block div input[name^='del_']").click(function(){
   delImage($(this));
  });

 });//$.get
}//getImageList
//======================== getImageList 終了============//

//======================== getReserveList 開始============//
function getReserveList(){
 $(dz).empty();
 var url="jsonGetReservelist.php";
 var data=null;
 $.get(url,data,function(html){
  //エラーチェック
  if(html.match(/エラー/)){
   $(dz).empty()
        .append(html);
   return false;
  }//if

  //JSONへ変換
  var json=eval("("+html+")");
  if(! json){
   $(dz).empty()
        .append("データがありません");
   return false;
  }
  var li="";
  var tstamp=new Date().getTime();
  for(var i in json["data"]){
   var j=json["data"][i];
   li+="<li>";
   li+="<div class='col2block'>";
   li+="<img src='../../img/"+j["jcode"]+".jpg?"+tstamp+"'>";
   li+="</div>\n";

   li+="<div class='col3block'>";
   li+="<div class=''>"+j["maker"]+"</div>";
   li+="<div class=''>"+j["sname"]+"</div>";
   li+="<div class=''>JAN:"+j["jcode"]+"</div>";
   li+="<div class=''>"+j["tani"]+" "+j["baika"]+"</div>";
   li+="</div>\n";

   li+="<div class='col3block'>";
   li+="<div class=''>";
   //以下のname属性を変更する場合、jsonSetImageUpLoad.phpの$_FILESも
   //変更してください
   li+="<input type='file' value='アップロード' name='upload_"+j["jcode"]+"' enctype='multipart/form-data'>";
   li+="</div>";
   li+="<div class=''>";
   li+="<input type='button' value='この画像を削除する' name='del_"+j["jcode"]+"'>";
   li+="</div>";
   li+="</div>\n";

   li+="<div class='clr'></div>";

   li+="</li>\n";
  }//for

  //データ表示
  $("<ul>").append(li)
           .appendTo($(dz));

  //ファイル選択 イベント追加
  $(dz +" ul li div.col3block div input[name^='upload_']").change(function(){
   setImageUpLoad($(this));
  });

  //削除 イベント追加
  $(dz +" ul li div.col3block div input[name^='del_']").click(function(){
   delImage($(this));
  });

 });//$.get
}//getReserveList()
//======================== getReserveList 終了============//

//======================== setImageUrl 開始============//
function setImageUrl(elem){
 //引数チェック
 var imageurl=elem.val();
 var jcode=elem.attr("name").match(/[0-9]+/)[0];
 var data={"jcode":jcode,"imageurl":imageurl};

 //画像タグゲット
 var imgtag=elem.parent()
                .parent()
                .parent()
                .find("img");
                //.siblings().eq(0).find("img");

 //imgディレクトリ
 var IMGDIR="../../img/";

 if(! imageurl ||! jcode) return false;

 //画像ゲット
 var url="./jsonSetImageConvert.php";
 $.get(url,data,function(html){
  //エラーチェック
  if(html.match(/エラー/)){
   elem.val(html);
   return false;
  }
  //JSON化
  var json=eval("("+html+")");
  if(! json || ! json["status"]){
   elem.val("原因不明のエラーです");
   return false;
  }

  //画像変更
  var tstamp=new Date().getTime();
  imgtag.attr("src",IMGDIR+json["data"]+"?"+tstamp);
 });//$.get
}
//======================== setImageUrl 終了============//

//======================== setList 開始 ==========//
function setList(json){
 //初期化
 $(dz).empty();

 var li="";
 var msg;
 //更新結果をセット
 if(json["status"]) msg="更新しました";
 else msg="エラーがあります";
 li+="<li>"+msg+"</li>\n";

 //列名セット
 li+="<li>";
 var calcnt=0;
 for( var i in json["local"]){
  li+="<div class='col1";
  if(calcnt==0) li+=" col1start'";
  li+="'>";

  li+=json["local"][i];
  li+="</div>";
  calcnt++;
 }
 li+="<div class='clr'></div>";
 li+="</li>\n";

 //データセット
 var flg=1;

 for(var i in json["data"]){
  li+="<li>";
  var calcnt=0;
  for(var j in json["local"]){
   var divcls="";
   divcls+="<div class='col1";
   if(calcnt==0) divcls+=" col1start";
   if(i==json["data"].length-1) divcls+=" row1end";
   divcls+="'>";
   li+=divcls;

   li+=json["data"][i][j];
   li+="</div>";
   calcnt++;
  }//for var j
  li+="<div class='clr'></div>";
  li+="</li>\n";
 }//for var i
 //データ表示
 $("<ul>").append(li)
          .appendTo($(dz));

}//setList
//======================== setList 終了 ==========//

//======================== setLi 開始 以下削除予定==========//
function setLi(json){
 //初期化
 $(dz).empty();

 var li="";
 var msg;
 //更新結果をセット
 if(json["status"]) msg="更新しました";
 else msg="エラーがあります";
 li+="<li>"+msg+"</li>\n";

 //列名セット
 li+="<li>";
 for( var i=0;i<json["local"].length;i++){
  li+="<div class='col1";
  if(i==0) li+=" col1start'";
  li+="'>";

  li+=json["local"][i];
  li+="</div>";
 }
 li+="<div class='clr'></div>";
 li+="</li>\n";

 //データセット
 var flg=1;

 var data=json["data"];

 for(var i in data){
  li+="<li>";
  for(var j in data[i]){
   var divcls="";
   divcls+="<div class='col1";
   if(j==0) divcls+=" col1start";
   if(i==data.length-1) divcls+=" row1end";
   divcls+="'>";

   li+=divcls;
   li+=data[i][j];
   li+="</div>";
  }//for j
  li+="<div class='clr'></div>";
  li+="</li>\n";
 } //for i

 //データ表示
 $("<ul>").append(li)
          .appendTo($(dz));
 
}
//======================== setLi 終了 ==================//

//======================== setClsMasCSV 開始 ==================//
function setClsMasCSV(elem){
 elem.upload("jsonSetClsMas.php",function(html){
  if(html.match(/エラー/)){
   $(dz).append(html);
  }
  
  var json=eval("("+html+")");
  var clsdata=json["clsmas"];
  var lindata=json["linmas"];
  $(dz).empty()
       .append(clsdata.data.length+"件追加しました");
 },"html");//elem
}//function
//======================== setClsMasCSV 終了 ==================//

//======================== setReserveCSV 開始 ==================//
function setReserveCSV(elem){
 //選択したファイルをDBへ更新し表示
 elem.upload("jsonSetReserve.php",function(html){
  //console.log(html);
  //エラーチェック
  if(html.match(/エラー/)){
   $(dz).append(html);
   return false;
  }

  //JSONへ変換
  var json=eval("("+html+")");
  if(! json){
   $(dz).append("データがありません");
   return false;
  }
  
  //データ表示
  setList(json);


  }//function
  ,"html"
 )//elem.upload
}
//======================== setReserveCSV 終了 ==================//

//======================== setCalendarCSV 開始 ==================//
function setCalendarCSV(elem){
 //選択したファイルをDBへ更新し表示
 elem.upload("jsonSetCalendar.php",function(html){
  //初期化
  $(dz).empty();

  //エラーチェック
  if(html.match(/エラー/)){
   $(dz).append(html);
   return false;
  }

  //JSONへ変換
  var json=eval("("+html+")");
  if(! json){
   $(dz).append("データがありません");
   return false;
  }
  
  //データ表示
  setList(json);

 },"html");
}
//======================== setCalendarCSV 終了 ==================//

//======================== setTirasiTitleCSV 開始 ==================//
function setTirasiTitleCSV(elem){
 //選択したファイルをDBへ更新し表示
 elem.upload("jsonSetTirasiTitle.php",function(html){
  //初期化
  $(dz).empty();

  //エラーチェック
  if(html.match(/エラー/)){
   $(dz).append(html);
   return false;
  }

  //JSONへ変換
  var json=eval("("+html+")");
  if(! json){
   $(dz).append("データがありません");
   return false;
  }

  //データ表示
  setList(json);

 },"html");
}
//======================== setTirasiTitleCSV 終了 ==================//

//======================== setTirasiItemCSV 開始 ==================//
function setTirasiItemCSV(elem){
 //選択したファイルをDBへ更新し表示
 elem.upload("jsonSetTirasiItem.php",function(html){
  //エラーチェック
  if(html.match(/エラー/)){
   $(dz).append(html);
   return false;
  }

  //JSONへ変換
  var json=eval("("+html+")");
  if(! json){
   $(dz).append("データがありません");
   return false;
  }

  //データ表示
  setList(json);

 },"html");
}
//======================== setTirasiItemCSV 終了 ==================//

//======================== setJanMasCSV 開始 ==================//
function setJanMasCSV(elem){
 //選択したファイルをDBへ更新し表示
 elem.upload("jsonSetJanMas.php",function(html){
  //エラーチェック
  if(html.match(/エラー/)){
   $(dz).append(html);
   return false;
  }

  //JSONへ変換
  var json=eval("("+html+")");
  if(! json){
   $(dz).append("データがありません");
   return false;
  }

  //データ表示
  var msg=json["data"]+"件登録しました";
  $(dz).empty()
       .append(msg);

  //エラーデータがあった場合、表示
  if(! json["status"]){
   json["data"]=json["errdata"];
   setList(json);
  }
  alert("終了しました");
  
 });//elem.upload
}
//======================== setJanMasCSV 終了 ==================//

//======================== setImageUpLoad 開始=================//
function setImageUpLoad(elem){
 var jcode=elem.attr("name").match(/[0-9]+/)[0];
 var data={"jcode":jcode};
 console.log(jcode);
 elem.upload("jsonSetImageUpLoad.php",data,function(html){
  //エラーチェック
  if(html.match(/エラー/)){
   elem.after(html);
   return false;
  }

  //ブラウザごまかすための適当な文字列をセット
  var timestamp=new Date().getTime();

  elem.parent()
      .parent()
      .parent()
      .find("img")
      .attr("src","../../img/"+html+"?"+timestamp);
 },"html");
}
//======================== setImageUpLoad 終了=================//

//======================== delImageUrl 開始============//
function delImage(elem){
 //JANコード取得
 var jcode=elem.attr("name").match(/[0-9]+/)[0];
 if(! jcode){
  alert("JANコードが不正です");
  return false;
 }

 //引数セット
 var url="delImage.php";
 var data={"jcode":jcode};

 //画像削除
 $.get(url,data,function(html){
  //エラーチェック
  if(html.match(/エラー/)){
   alert(html);
   return false;
  }//if

  //ブラウザごまかすための適当な文字列をセット
  var timestamp=new Date().getTime();

  elem.parent()
      .parent()
      .parent()
      .find("img")
      .attr("src","../../img/"+timestamp);
  alert("削除しました");
  return true;
 });//$.get
}
//======================== delImageUrl 終了============//

//======================== errMsg 開始 ==================//
function errMsg(html){
 console.log(html);
 f.empty()
  .append(html);
 return false;
}
//======================== errMsg 終了 ==================//
  </script>
 </head>
 <body>
  <!-- wrapper -->
  <div id="wrapper">

   <!-- header -->
   <div id="header">

    <!-- logo -->
    <div class="logo">
     <a href="../../index.html">
      <img src="../../img/logo2.jpg" alt="スーパーキタムラ">
     </a>
    </div>
    <!-- logo -->

    <!-- hello -->
    <div class="hello">
     <p>
     </p>
    </div>
    <!-- hello -->

    <!-- mininavi -->
    <div class="mininavi">
     <ul>
      <li><a href="../../about.html">会社概要</a></li>
      <li><a href="../../access.html">アクセス</a></li>
      <li>求人</li>
      <li><a href="../../sinsotu.html"> 新卒採用</a></li>
     </ul>
    </div>
    <!-- mininavi -->

    <!-- timesale -->
    <div class="timesale">
     <ul>
      <li>本日のおすすめ</li>
      <li> | </li>
      <li>今週のチラシ</li>
      <li> | </li>
      <li>今月のお買得品</li>
      <li> | </li>
      <li>ご注文承り中</li>
      <li> | </li>
      <li>サービス</li>
     </ul>
    </div>
    <!-- timesale -->
     
   <div class="clr"></div>
   </div>
   <!-- header -->

   <!-- navi -->
   <div id="navi">
    <!-- allcate -->
    <div id="allcate">
    </div>
    <!-- allcate -->

    <!-- search -->
    <div id="search">
    </div>
    <!-- search -->
   </div>
   <!-- navi -->

   <!-- leftside -->
   <div id="leftside">
    <ul>
     <!-- 以下のクラス名はconfig.php内のファイル名定数と
          合わせる必要がある -->
     <li><a href="#" class="calendar">カレンダー更新</a></li>
     <li><a href="#" class="tirasititle">チラシタイトル更新</a></li>
     <li><a href="#" class="tirasiitem">チラシデータ更新</a></li>
     <li><a href="#" class="tirasiimage">チラシ画像更新</a></li>
     <li><a href="#" class="reserve">ご予約商品更新</a></li>
     <li><a href="#" class="reserveimage">ご予約商品画像更新</a></li>
     <li><a href="#" class="janmas">商品マスタ更新</a></li>
     <li><a href="#" class="clsmas">部門マスタ更新</a></li>
    </ul>
   </div>
   <!-- leftside -->

   <!-- rightside -->
   <div id="rightside">
   </div>
   <!-- rightside -->

   <!-- main -->
   <div id="main">
    <div class="btnzone"></div>
    <div class="datazone"></div>
   </div>
   <!-- main -->

   <div class="clr"></div>
   <!-- footer -->
   <div id="footer">
    <h1>footer</h1>
   </div>
   <!-- footer -->

  </div>
  <!-- wrapper -->
 </body>
</html>
